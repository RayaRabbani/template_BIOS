# Tutorial Penggunaan Template Demplon Child

Panduan ini menjelaskan langkah-langkah untuk menyesuaikan dan menggunakan template aplikasi child yang terintegrasi dengan Demplon dan Kujang ID.

---

## 1. Ganti Favicon

Favicon default berada di **`app/favicon.ico`**.

- Ganti file `app/favicon.ico` dengan file favicon aplikasi Anda (format `.ico` disarankan).
- Atau tambahkan di `app/layout.tsx` melalui metadata jika menggunakan format lain (PNG, SVG):

```ts
export const metadata: Metadata = {
  title: 'Nama Aplikasi',
  description: 'Deskripsi aplikasi',
  icons: {
    icon: '/favicon.ico', // atau path ke gambar lain
  },
};
```

---

## 2. Ganti Metadata di `app/layout.tsx`

Ubah metadata aplikasi agar sesuai branding dan SEO:

**File:** `app/layout.tsx`

```ts
export const metadata: Metadata = {
  title: 'Demplon Child',           // ganti dengan nama aplikasi
  description: 'Generated by Demplon Child',  // ganti dengan deskripsi
  // opsional: keywords, openGraph, twitter, dll.
};
```

Sesuaikan `title`, `description`, dan tambahkan field metadata lain sesuai kebutuhan (misalnya `keywords`, `openGraph`, `twitter`).

---

## 3. Konfigurasi Auth — Daftarkan Aplikasi ke Admin

Autentikasi menggunakan **Kujang ID** (OIDC). Agar aplikasi bisa login, aplikasi harus terdaftar di **Admin Aplikasi** untuk mendapatkan **clientId** dan **clientSecret**.

**File:** `lib/auth.ts`

Setelah mendapat kredensial dari admin, isi di provider OIDC:

```ts
{
  clientId: 'ai',        // ganti dengan clientId dari admin
  clientSecret: 'bb20...', // ganti dengan clientSecret dari admin
  id: 'kujang-id',
  name: 'KUJANG ID IdP',
  type: 'oidc',
  issuer: 'https://id.pupuk-kujang.co.id',
  // ... endpoint lainnya tetap
}
```

- **Jangan** commit `clientSecret` ke repository. Simpan di environment variable, contoh:

```ts
clientId: process.env.KUJANG_CLIENT_ID!,
clientSecret: process.env.KUJANG_CLIENT_SECRET!,
```

Lalu isi `.env.local`:

```
KUJANG_CLIENT_ID=your-client-id
KUJANG_CLIENT_SECRET=your-client-secret
```

---

## 4. Hubungkan Backend — Role & Permission (Abilities)

Permission per user disediakan oleh **backend Anda**. Template mengharapkan format data yang sudah ditentukan.

**File:** `lib/abilities.ts`

Fungsi `getAbilitiesFromBackend()` memanggil backend dan harus mengembalikan data dengan format **Abilities**:

### Format data dari backend

**Types:** `types/permissions.ts`

```ts
// Role: kumpulan akses per role
interface Role {
  id: string;           // id role, misal: 'admin', 'viewer'
  subjects: Subject[];
}

// Subject: resource + daftar permission
interface Subject {
  id: string;           // nama resource, misal: 'budgets', 'users'
  permissions: string[]; // aksi: 'view', 'create', 'edit', 'delete', dll
}

// Response backend = array of Role
type Abilities = Role[];
```

**Contoh response backend:**

```json
[
  {
    "id": "admin",
    "subjects": [
      {
        "id": "budgets",
        "permissions": ["view", "create", "edit", "delete"]
      },
      {
        "id": "users",
        "permissions": ["view", "edit"]
      }
    ]
  }
]
```

Di `lib/abilities.ts`:

1. Panggil endpoint backend (misalnya `GET /api/permissions` atau sesuai API Anda).
2. Kirim **idToken** (atau legacyIdToken) di header `Authorization: Bearer <token>`.
3. Parse response JSON ke tipe `Abilities` dan return.

Contoh (uncomment dan sesuaikan URL):

```ts
const token = session.idToken || session.legacyIdToken;
const response = await fetch(`${process.env.BACKEND_API_URL}/api/permissions`, {
  headers: {
    Authorization: `Bearer ${token}`,
    'Content-Type': 'application/json',
  },
});
const data: Abilities = await response.json();
return data;
```

Set variabel env `BACKEND_API_URL` di `.env.local`.

---

## 5. Autentikasi Backend dengan idToken dari Kujang ID

Backend Anda harus memvalidasi request menggunakan **idToken** yang dikeluarkan Kujang ID.

- **Client (template):** Setelah login, idToken tersimpan di session dan bisa diambil untuk panggilan API (misalnya di `lib/abilities.ts` dan di `lib/api.ts` jika dipakai).
- **Backend:**  
  - Terima header `Authorization: Bearer <idToken>`.  
  - Validasi idToken (JWT) dengan konfigurasi OIDC Kujang ID (issuer, JWKS, audience, dll.).  
  - Dari payload token bisa didapat `sub`, roles, groups, dll. untuk authorization dan untuk mengembalikan data abilities per user.

Pastikan backend hanya menerima dan memvalidasi idToken dari issuer yang benar (`https://id.pupuk-kujang.co.id` atau sesuai konfigurasi).

---

## 6. Dua Sidebar di `components/app-sidebar.tsx`

Di `components/app-sidebar.tsx` ada **dua sidebar**:

### Sidebar 1 (jangan diubah)

- **Blok pertama** (komponen `<Sidebar>` pertama di dalam file).
- Class: `w-[calc(var(--sidebar-width-icon)+1px)]!`, `collapsible="none"`.
- Ini dirancang untuk terhubung langsung dengan **Demplon** (navigasi utama/platform).
- **Jangan mengubah struktur dan perilaku sidebar ini** agar integrasi dengan Demplon tetap berfungsi.

### Sidebar 2 (boleh dikustomisasi)

- **Blok kedua** (komponen `<Sidebar>` berikutnya).
- Class: `hidden min-w-0 flex-1 group-data-[collapsible=icon]:!w-[var(--sidebar-width-icon)] ...`.
- Ini sidebar aplikasi Anda: menu, navigasi, dan konten bisa diubah sesuai kebutuhan (ganti `navMain`, item menu, link, icon, dll.).

Anda bisa mengubah data menu (`data.navMain` untuk sidebar 2), menambah/menghapus item, dan mengarahkan ke route aplikasi Anda.

---

## 7. Contoh Penggunaan Cek Permission

Permission di UI dan API menggunakan **CASL** dengan format abilities di atas.

### Di halaman (client) — `app/(app)/page.tsx`

Gunakan hook **`useAbilities()`**:

```ts
import { useAbilities } from '@/hooks/use-abilities';

export default function Page() {
  const { ability, isLoading } = useAbilities();

  if (isLoading) return <div>Loading...</div>;

  return (
    <div>
      {ability?.can('view', 'budgets') && (
        <Link href="/budgets">Lihat Budget</Link>
      )}
      {ability?.can('create', 'budgets') && (
        <button>Buat Budget</button>
      )}
      {ability?.can('edit', 'budgets') && (
        <button>Edit</button>
      )}
      {ability?.can('delete', 'budgets') && (
        <button>Hapus</button>
      )}
    </div>
  );
}
```

- `ability.can(action, subject)` — action: `'view'`, `'create'`, `'edit'`, `'delete'`, dll.; subject: id subject dari abilities (misal `'budgets'`).
- Hook memuat abilities dari **`/api/abilities`**, yang memanggil `getAbilitiesFromBackend()` di `lib/abilities.ts`.

### Di API route (server) — cek permission sebelum return data

**File contoh:** `app/api/example-protected/route.ts`

```ts
import { canUserPerform } from '@/lib/check-ability';

export async function GET() {
  const canView = await canUserPerform('view', 'budgets');

  if (!canView) {
    return NextResponse.json(
      { error: 'Forbidden: You do not have permission to view budgets' },
      { status: 403 }
    );
  }

  return NextResponse.json({ message: 'OK', data: { ... } });
}
```

- **`canUserPerform(action, subject)`** memakai session saat ini dan `getAbilitiesFromBackend()`, lalu mengecek apakah user punya permission yang diminta.
- Gunakan pola yang sama di route API lain yang perlu proteksi per action/subject.

---

## Ringkasan

| No | Item | Lokasi / Catatan |
|----|------|-------------------|
| 1 | Favicon | `app/favicon.ico` (atau lewat metadata di layout) |
| 2 | Metadata (title, description) | `app/layout.tsx` → `metadata` |
| 3 | clientId / clientSecret | Daftar ke admin aplikasi, set di `lib/auth.ts` (lebih aman pakai env) |
| 4 | Backend abilities | `lib/abilities.ts` — backend supply JSON format `Abilities` (Role[] dengan subjects & permissions) |
| 5 | Auth backend | Validasi idToken (JWT) dari Kujang ID di backend |
| 6 | Sidebar 1 | Jangan diubah (Demplon). Sidebar 2 di `components/app-sidebar.tsx` bebas dikustomisasi |
| 7 | Cek permission | Client: `useAbilities()` + `ability.can(action, subject)`. Server: `canUserPerform(action, subject)` di API route |

Dengan mengikuti langkah di atas, template siap disesuaikan dengan branding, backend, dan aturan akses aplikasi Anda.
